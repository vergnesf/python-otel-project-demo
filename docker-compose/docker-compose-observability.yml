version: '3.8'

services:
  grafana:
    image: ${DOCKER_REGISTRY:-}${DOCKER_IMG_GRAFANA}
    container_name: grafana
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
      GF_FEATURE_TOGGLES_ENABLE: tempoServiceGraph,traceToMetrics
      GF_AUTH_DISABLE_LOGIN_FORM: "true"
      GF_SERVER_ROOT_URL: 'http://localhost:8010/grafana'
      GF_SERVER_SERVE_FROM_SUB_PATH: 'true'
    volumes:
      - ${PWD}/config/grafana/datasources:/etc/grafana/provisioning/datasources:Z
      - grafana-data:/var/lib/grafana
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - otel-network

  otel-collector:
    image: ${DOCKER_REGISTRY:-}${DOCKER_IMG_OTEL_COLLECTOR}
    container_name: otel-collector
    command: ["--config=/etc/otel-conf.yml"]
    volumes:
      - ${PWD}/config/otel/otel-conf.yml:/etc/otel-conf.yml:Z
    depends_on:
      - mimir
      - loki
      - tempo
    restart: unless-stopped
    networks:
      - otel-network

  loki:
    image: ${DOCKER_REGISTRY:-}${DOCKER_IMG_LOKI}
    container_name: loki
    command: ["-config.file=/etc/config/loki.yaml"]
    user: "0:0"
    volumes:
      - ${PWD}/config/loki/loki-config.yml:/etc/config/loki.yaml:Z
      - loki-data:/tmp/loki
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - otel-network

  tempo:
    image: ${DOCKER_REGISTRY:-}${DOCKER_IMG_TEMPO}
    container_name: tempo
    command: ["-config.file=/etc/tempo.yaml"]
    user: "0:0"
    volumes:
      - ${PWD}/config/tempo/tempo.yml:/etc/tempo.yaml:Z
      - tempo-data:/tmp/tempo
    restart: unless-stopped
    networks:
      - otel-network

  mimir:
    image: ${DOCKER_REGISTRY:-}${DOCKER_IMG_MIMIR}
    container_name: mimir
    command: ["-config.file=/etc/mimir-config.yml"]
    volumes:
      - ${PWD}/config/mimir/mimir-config.yml:/etc/mimir-config.yml:Z
      - mimir-data:/tmp/mimir
    restart: unless-stopped
    networks:
      - otel-network

volumes:
  grafana-data:
  loki-data:
  tempo-data:
  mimir-data:

networks:
  otel-network:
    external: true
